var bookListing = {
    bookJson:{"title": "","genre":"","author":"","description":"","publisher":"","pagecount":"","originallypublished":"","thumbnail":""},
    bookListingJson: [
        {
            "id":1,
            "heading": "Mothering Heights (B&N Exclusive Edition) (Dog Man Series #10)",
            "description": "While usually set in a fictional imagined world—in opposition, Ta-Nehisi's Coates's The Water Dancer takes place in the very real world of American slavery—fantasy books include prominent elements of magic, mythology, or the supernatural.",
            "status": "",
            "price": "$2000",
            "bookdetails": {
                "id":1,
                "title": "Mothering Heights",
                "genre": "Thriller",
                "author": "Sophia Hill",
                "description": "While usually set in a fictional imagined world—in opposition, Ta-Nehisi's Coates's The Water Dancer takes place in the very real world of American slavery—fantasy books include prominent elements of magic, mythology, or the supernatural.",
                "publisher": "B&N Exclusive",
                "pagecount": "",
                "originallypublished": "",
                "thumbnailUrl": "../images/book covers/1.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
        {
            "id": 2,
            "heading": "Jujutsu Kaisen, Vol. 1 ",
            "description": "",
            "status": "1",
            "price": "$0",
            "photos": [],
            "bookdetails": {
                "id": 2,
                "title": "Jujutsu Kaisen",
                "genre": "Adventure fiction, Dark fantasy, Occult FictionPA",
                "author": "Gege Akutami",
                "description": "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.",
                "publisher": "MAPPA",
                "pagecount": "24",
                "originallypublished": "July 4, 2018",
                "thumbnail": "../images/book covers/2.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
        {
            "id": 3,
            "heading": "The Madness of Crowds(Chief Inspector Gamache Series #17)",
            "description": "",
            "status": "1",
            "price": "$89.98",
            "photos": [],
            "bookdetails": {
                "id": 3,
                "title": "The Madness of Crowds",
                "genre": "Race, LGBT",
                "author": "Douglas Murray",
                "description": "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.",
                "publisher": "Bloomsbury Publishing",
                "pagecount": "288",
                "originallypublished": "September 17, 2019",
                "thumbnail": "../images/book covers/3.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
        {
            "id": 4,
            "heading": "The Night Fire",
            "description": "These books are based in a time period set in the past decades, often against the backdrop of significant (real) historical events.",
            "status": "",
            "price": "",
            "photos": [],
            "bookdetails": {
                "id": 4,
                "title": "The Night Fire",
                "genre": "Thriller, Mystery, Police procedural, Urban fiction, Crime Fiction",
                "author": "Michael Connelly",
                "description": "Back when Harry Bosch was just a rookie homicide detective he had an inspiring mentor, John Jack Thompson, who taught him to take the work personally and light the fire of relentlessness for every case.",
                "publisher": "",
                "pagecount": "380",
                "originallypublished": "October 21, 2019",
                "thumbnail": "../images/book covers/4.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
        {
            "id": 5,
            "heading": "The Adventures of Sherlock Holmes",
            "description": "Sherlock Holmes",
            "status": "1",
            "price": "",
            "photos": [],
            "bookdetails": {
                "id": 5,
                "title": "The Adventures of Sherlock Holmes",
                "genre": "Novel, Short story, Mystery, Detective novel, Noir fiction, Crime Fiction",
                "author": "Arthur Conan Doyle",
                "description": "The Adventures of Sherlock Holmes is a collection of twelve short stories by Arthur Conan Doyle, first published on 14 October 1892.",
                "publisher": "Sidney Paget",
                "pagecount": "307",
                "originallypublished": "October 14, 1892",
                "thumbnail": "../images/book covers/5.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
        {
            "id": 6,
            "heading": "Circe",
            "description": "The plot always revolves around a crime of sorts that must be solved—or foiled—by the protagonists.",
            "status": "1",
            "price": "",
            "photos": [],
            "bookdetails": {
                "id": 6,
                "title": "Circe",
                "genre": "Novel, Historical Fiction, Fantasy Fiction",
                "author": "Madeline Miller",
                "description": "A bold and subversive retelling of the goddess's story,' this #1 New York Times bestseller is 'both epic and intimate in its scope, recasting the most infamous female figure from the Odyssey as a hero in her own right'(Alexandra Alter, The New York Times).",
                "publisher": "",
                "pagecount": "419",
                "originallypublished": "April 10, 2018",
                "thumbnail": "../images/book covers/6.jfif",
                "ISBN": 9781408890042,
                "originallanguage":"English"
            }
        },
        {
            "id": 7,
            "heading": "Ninth House",
            "description": "These books are based in a time period set in the past decades, often against the backdrop of significant (real) historical events.",
            "status": "1",
            "price": "$50",
            "photos": [],
            "bookdetails": {
                "id": 7,
                "title": "Ninth House",
                "genre": "Fantasy Fiction, Thriller",
                "author": "Leigh Bardugo",
                "description": "Ninth House is a dark fantasy new adult novel by American author Leigh Bardugo published by Flatiron Books in 2019.",
                "publisher": "Macmillan Publishers",
                "pagecount": 458,
                "originallypublished": "October 8, 2019",
                "thumbnail": "../images/book covers/7.jfif",
                "ISBN": "",
                "originallanguage": "English"
            }
        },
        {
            "id": 8,
            "heading": "One Hundred Years of Solitude",
            "description": "The plot always revolves around a crime of sorts that must be solved—or foiled—by the protagonists.",
            "status": "1",
            "price": "$300",
            "photos": [],
            "bookdetails": {
                "id": 8,
                "title": "One Hundred Years of Solitude",
                "genre": "Novel, Magical Realism, High fantasy, Family saga, Epic Fiction",
                "author": "Gabriel García Márquez",
                "description": "One Hundred Years of Solitude is a landmark 1967 novel by Colombian author Gabriel García Márquez that tells the multi-generational story of the Buendía family, whose patriarch, José Arcadio Buendía, founded the town of Macondo. The novel is often cited as one of the supreme achievements in literature.",
                "publisher": "",
                "pagecount": 433,
                "originallypublished": "1967",
                "thumbnail": "../images/book covers/8.jfif",
                "ISBN": "",
                "originallanguage": "Spanish"
            }
        },
        {
            "id": 9,
            "heading": "Carrie",
            "description": "While usually set in a fictional imagined world—in opposition, Ta-Nehisi's Coates's The Water Dancer takes place in the very real world of American slavery—fantasy books include prominent elements of magic, mythology, or the supernatural.",
            "status": "1",
            "price": "$100",
            "photos": [],
            "bookdetails": {
                "id": 9,
                "title": "Carrie",
                "genre": "Horror fiction, Epistolary novel",
                "author": "Stephen King",
                "description": "Carrie is an epistolary horror novel by American author Stephen King. It was his first published novel, released on April 5, 1974, with a first print-run of 30,000 copies.",
                "publisher": "Doubleday",
                "pagecount": 199,
                "originallypublished": "November 3, 1976",
                "thumbnail": "../images/book covers/9.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
        {
            "id": 10,
            "heading": "Bird Box",
            "description": "Meant to cause discomfort and fear for both the character and readers, horror writers often make use of supernatural and paranormal elements in morbid stories that are sometimes a little too realistic. The master of horror fiction? None other than Stephen King.",
            "status": "1",
            "price": "$50",
            "photos": [],
            "bookdetails": {
                "id": 10,
                "title": "Bird Box",
                "genre": "Novel, Thriller, Horror fiction, Suspense, Apocalyptic and post-apocalyptic fiction",
                "author": "Josh Malerman",
                "description": "Bird Box is a 2014 post-apocalyptic novel and the debut novel by American writer and singer Josh Malerman. The book was first published in the United Kingdom on March 27, 2014, through Harper Voyager and in the United States on May 13, 2014, through Ecco Press.",
                "publisher": "",
                "pagecount": 273,
                "originallypublished": "March 27, 2014",
                "thumbnail": "../images/book covers/10.jfif",
                "ISBN": "",
                "originallanguage": ""
            }
        },
    ],
    add: function (dataJson) {
        api.postCall("booklisting", dataJson, function (result) {
            alert("Book successfully added!");
            //reset form
            $form = $("#addBookListingContainer");
            $form.find(".error-note").each(function () { $(this).html(""); });
            $form.find("input.form-control").not(".btn").each(function () { $(this).val(""); });
        });
    },
    update: function () { },
    delete: function () { },
    loadGrid: function () {
        api.getCall("users/getdetails", {}, function (userResult) {
            localStorage.setItem('user', JSON.stringify(userResult));
            //load user thumbnail in menu
            var $img = $(window.parent.document.body).find(".user-profile > img");
            if (userResult.thumbnailUrl != null && userResult.thumbnailUrl != undefined)
                $img.attr("src", hostpath + userResult.thumbnailUrl).show();
            else
                $img.attr("src", hostpath + "assets/books/no-image.jpg").show();

            if (userResult.role == "ROLE_ADMIN")
                $(window.parent.document.body).find("#linkAddMainBook").show();

        });

        api.getCall("booklisting/getall", {}, function (result) {
            localStorage.setItem('booklistings', JSON.stringify(result));
            var $main = $("#book_listing_container");
            $main.html("");
            $("#authorList").html("<option value='all'>All</option>");
            $("#genreList").html("<option value='all'>All</option>");
            var authorList = [];
            var genreList = [];
            bookList = result;
            $.each(bookList, function (i, o) {
                var templateHTML = $("#book_list_thumbnail").html();
                templateHTML = templateHTML.replace("{{id}}", o.bookListingId);
                templateHTML = templateHTML.replace("{{bookid}}", o.bookId);
                templateHTML = templateHTML.replace("{{author}}", o.bookDetails.author);
                templateHTML = templateHTML.replace("{{genre}}", o.bookDetails.category);
                templateHTML = templateHTML.replace("{{thumbnail}}", o.bookDetails.thumbnailUrl == "" || o.bookDetails.thumbnailUrl == null || o.bookDetails.thumbnailUrl == undefined ? hostpath + "assets/books/no-image.jpg" : hostpath + o.bookDetails.thumbnailUrl);
                templateHTML = templateHTML.replace("{{heading}}", o.heading);
                templateHTML = templateHTML.replace("{{price}}", o.price == "" ? "$0" : o.price);
                templateHTML = templateHTML.replace("{{description}}", o.description.length > 120 ? o.description.substring(0, 120) + "..." : o.description);
                $main.append(templateHTML);

                if (!authorList.includes(o.bookDetails.author) && o.bookDetails.author != "" && o.bookDetails.author != undefined) {
                    $("#authorList").append('<option value="' + o.bookDetails.author + '">' + o.bookDetails.author + '</option>');
                    authorList.push(o.bookDetails.author);
                }

                if (!genreList.includes(o.bookDetails.category) && o.bookDetails.category != "" && o.bookDetails.category != undefined) {
                    $("#genreList").append('<option value="' + o.bookDetails.category + '">' + o.bookDetails.category + '</option>');
                    genreList.push(o.bookDetails.category);
                }
            });
            bookListing.attachEventHandlers($main);
        });
    },
    loadMyGrid: function () {
        var $main = $("#my_listing_container");
        $main.html("");
        api.getCall("booklisting", {}, function (result) {
            $.each(result, function (i, o) {
                var templateHTML = $("#my_book_list_thumbnail").html();
                templateHTML = templateHTML.replace("{{id}}", o.bookListingId);
                templateHTML = templateHTML.replace("{{thumbnail}}", o.bookDetails.thumbnailUrl);
                templateHTML = templateHTML.replace("{{heading}}", o.heading);
                templateHTML = templateHTML.replace("{{price}}", o.price == "" ? "$0" : o.price);
                templateHTML = templateHTML.replace("{{description_full}}", o.description);
                templateHTML = templateHTML.replace("{{description}}", o.description.length > 120 ? o.description.substring(0, 120) + "..." : o.description);
                $main.append(templateHTML);
            });

            var selectedBookId = "";
            $(".btnEditBookListing").click(function () {
                $("#editListingModal").show();
                var $thumbnail = $(this).closest(".details-container");
                selectedBookId = $(this).closest(".details-container").attr("id");
                $("#txtEditBookListingName").val($thumbnail.find(".heading-container").text());
                $("#txtEditBookListingDesc").val($thumbnail.find(".desc").text());
                $("#txtEditBookListingPrice").val($thumbnail.find(".span-price").text());
            });

            $(".btnDeleteBookListing").click(function () {
                $("#editListingModal").hide();
                var selectedBookId = $(this).closest(".details-container").attr("id");
                if (confirm("Are you sure you want to delete this book?")) {
                    api.deleteCall("booklisting?bookListingId=" + parseInt(selectedBookId), function (result) {
                        alert("Book successfully deleted!");
                        main.loadpage("my-booklistings");
                    });
                }
            });

            $("#btnSaveEditBookListing").click(function () {
                var $thumbnail = $("#" + selectedBookId);
                var dataJson = {
                    "bookListingId": parseInt($thumbnail.attr("id")),
                    "heading": $("#txtEditBookListingName").val(),
                    "description": $("#txtEditBookListingDesc").val(),
                    "price": $("#txtEditBookListingPrice").val()
                }

                api.putCall("booklisting", dataJson, function (result) {
                    alert("Book successfully updated!");
                    $("#editListingModal").hide();
                    main.loadpage("my-booklistings");
                });
            });

            $("#editListingModal .close-modal").click(function () {
                $("#editListingModal").hide();
            });
        });
        bookListing.attachEventHandlers($main);
    },
    gridCallback: function () {
        $(".span-price").each(function () {
            if ($(this).html() == "")
                $(this).html("$0");
        });

        $(".span-desc").each(function () {
            var thisHTML = $(this).html();
            if (thisHTML.length > 200)
                $(this).html(thisHTML.substring(0, 200) + "...");
            if (thisHTML == "")
                $(this).html("None");
        });
    },
    attachEventHandlers: function ($main) {
        $main.find(".img-col").mouseenter(function () {
            $(this).find(".cover-hover").fadeIn();
        }).mouseleave(function () {
            $(this).find(".cover-hover").fadeOut();
        });

        $main.find(".btnAboutBook").click(function () {
            var bookListingId = $(this).parents(".thumbnail").attr("bookid");
            localStorage.setItem('selectedBook', bookListingId);
            main.loadpage("book");
        });

        $main.find(".btnSendSellerDetails").click(function () {
            var bookId = parseInt($(this).closest(".thumbnail").attr("id"));
            if (confirm("Your details will be shared with seller. To continue click OK.")) {
                api.postCall("/booklisting/interested?bookListingId=" + bookId, {}, function (result) {
                    alert("We have shared your details with Seller. Seller will contact you soon!");
                });
            }
        });

        $("#authorList").change(function () {
            var thisVal = $(this).val();
            if (thisVal == "all")
                $("#book_listing_container").find(".thumbnail").show();
            else {
                $("#book_listing_container").find(".thumbnail[author='" + thisVal + "']").show();
                $("#book_listing_container").find(".thumbnail").not("[author='" + thisVal + "']").hide();
            }
            $("#genreList").find("option:first").prop("selected", true);
            $("#genreList").val("all");
        });

        $("#genreList").change(function () {
            var thisVal = $(this).val();
            if (thisVal == "all")
                $("#book_listing_container").find(".thumbnail").show();
            else {
                $("#book_listing_container").find(".thumbnail[genre='" + thisVal + "']").show();
                $("#book_listing_container").find(".thumbnail").not("[genre='" + thisVal + "']").hide();
            }
            $("#authorList").find("option:first").prop("selected", true);
            $("#authorList").val("all");
        });

        
    },
    getForUser: function () { },
    loadAllbooks: function () {
        $("#addBookListingContainer").find("#btnAddBookListing").click(function () {
            var bookListingJson = {
                "bookId": $("#listSelectBook").val(),
                "description": $("#txtBookListingDesc").val(),
                "heading": $("#txtBookListingName").val(),
                "price": $("#txtBookListingPrice").val(),
                "rentalDetailDTO": {
                    "endDate": $("#txtBookListingRentEnd").val(),
                    "startDate": $("#txtBookListingRentStart").val()
                },
                "type": $("#txtBookListingType").val(),
            };
            bookListing.add(bookListingJson);
        });

        api.getCall("books/getall", {}, function (result) {
            var $listSelectBook = $("#listSelectBook");
            var options = "";
            $.each(result, function (i, o) {
                options += "<option value=" + o.id + ">" + o.title+"</option>";
            });
            $listSelectBook.html(options);
        });
        
    }
}

var book = {
    id: null,
    add: function (dataJson,thumbnail) {
            api.postCall("books", dataJson, function (result) {
                var formdata = new FormData();
                formdata.append("file", thumbnail);
                api.uploadFileCall("books/thumbnail?bookId="+result.id, formdata, function (result) {
                    alert("Book successfully added!");
                    $form = $("#addBookContainer");
                    $form.find(".error-note").each(function () { $(this).html(""); });
                    $form.find("input.form-control").not(".btn").each(function () { $(this).val(""); });
                });
            });
    },
    showDetails: function () {
        var allBookListings = $.parseJSON(localStorage.getItem('booklistings'));
        var bookListingId = localStorage.getItem('selectedBook');
        if (!isNullorUndefined(bookListingId)) {
            var bookData= allBookListings.filter(function (obj, ind) {
                return obj.bookId == bookListingId;
            })[0];
            var bookDetails=bookData.bookDetails;
            var templateHTML = $("#book_details").html();
            templateHTML = templateHTML.replace("{{id}}", bookDetails.id);
            templateHTML = templateHTML.replace("{{title}}", bookDetails.title);
            templateHTML = templateHTML.replace("{{author}}", bookDetails.author);
            templateHTML = templateHTML.replace("{{genre}}", bookDetails.category);
            templateHTML = templateHTML.replace("{{thumbnail}}", bookDetails.thumbnailUrl == "" || bookDetails.thumbnailUrl == null || bookDetails.thumbnailUrl == undefined ? hostpath + "assets/books/no-image.jpg" : hostpath + bookDetails.thumbnailUrl);
            templateHTML = templateHTML.replace("{{publisher}}", bookDetails.publisher);
            templateHTML = templateHTML.replace("{{edition}}", bookDetails.edition);
            templateHTML = templateHTML.replace("{{pagecount}}", bookDetails.pageCount);
            templateHTML = templateHTML.replace("{{ISBN}}", bookDetails.isbn);
            templateHTML = templateHTML.replace("{{originallypublished}}", bookDetails.publishedDate);
            templateHTML = templateHTML.replace("{{originallanguage}}", bookDetails.originalLanguage);
            templateHTML = templateHTML.replace("{{description}}", bookDetails.description);
            $("#book_container").html(templateHTML);
        }
    },
    gridCallback: function () {
        $(".div_desc").each(function () {
            if ($(this).find("span").html() == "")
                $(this).find("span").html("Not specified");
        });
    },
    showAll: function () {
        api.getCall("books/getall", {}, function (result) {
            var $main = $("#allbooks_container");
            $.each(result, function (i, o) {
                var templateHTML = $("#allbooks_thumbnail").html();
                templateHTML = templateHTML.replace("{{id}}", o.id);
                templateHTML = templateHTML.replace("{{title}}", o.title);
                templateHTML = templateHTML.replace("{{thumbnail}}", o.thumbnailUrl == "" || o.thumbnailUrl == null || o.thumbnailUrl == undefined ? hostpath + "assets/books/no-image.jpg" : hostpath + o.thumbnailUrl);
                templateHTML = templateHTML.replace("{{description}}", o.description.length > 120 ? o.description.substring(0, 120) + "..." : o.description);
                $main.append(templateHTML);
            });

            $main.find(".loadBookInfo").click(function () {
                var id = $(this).closest(".thumbnail").attr("id");
                localStorage.setItem('selectedBook', id);
                main.loadpage("allbooks-more");
            });
        });
    }
}

var textoptions = {
    trimString: function (maxLength, str) {
        if ($.trim(str).length > maxLength)
            return str.substring(0, maxLength)+"...";
        else
            return str;
    }
}